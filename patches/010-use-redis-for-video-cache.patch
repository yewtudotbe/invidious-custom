From 166f2108c81a0569427b5fa53c532655418e3e65 Mon Sep 17 00:00:00 2001
From: Your Name <you@example.com>
Date: Sat, 7 Feb 2026 10:57:40 +0000
Subject: [PATCH] use redis for video cache

---
 shard.yml                        |  2 ++
 src/invidious.cr                 |  6 ++++++
 src/invidious/config.cr          |  3 +++
 src/invidious/database/videos.cr | 16 +++++++++++++++-
 src/invidious/videos.cr          |  2 +-
 5 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/shard.yml b/shard.yml
index dde1851..3671b10 100644
--- a/shard.yml
+++ b/shard.yml
@@ -31,6 +31,8 @@ dependencies:
   http_proxy:
     github: mamantoha/http_proxy
     version: ~> 0.10.3
+  redis:
+    github: stefanwille/crystal-redis
 
 development_dependencies:
   spectator:
diff --git a/src/invidious.cr b/src/invidious.cr
index d7c5b80..c528bae 100644
--- a/src/invidious.cr
+++ b/src/invidious.cr
@@ -30,6 +30,7 @@ require "xml"
 require "yaml"
 require "compress/zip"
 require "protodec/utils"
+require "redis"
 
 require "./invidious/database/*"
 require "./invidious/database/migrations/*"
@@ -67,6 +68,11 @@ rescue ex
   puts "Check your 'config.yml' database settings or PostgreSQL settings."
   exit(1)
 end
+REDIS_DB = Redis::PooledClient.new(unixsocket: CONFIG.redis_socket || nil, url: CONFIG.redis_url || nil)
+
+if REDIS_DB.ping
+  puts "Connected to redis"
+end
 HOST_URL           = make_host_url(Kemal.config)
 MAX_ITEMS_PER_PAGE = 1500
 
diff --git a/src/invidious/config.cr b/src/invidious/config.cr
index 7853d9a..b263ea5 100644
--- a/src/invidious/config.cr
+++ b/src/invidious/config.cr
@@ -111,6 +111,9 @@ class Config
   # Used for crawling channels: threads should check all videos uploaded by a channel
   property full_refresh : Bool = false
 
+  property redis_url : String?
+  property redis_socket : String?
+
   # Jobs config structure. See jobs.cr and jobs/base_job.cr
   property jobs = Invidious::Jobs::JobsConfig.new
 
diff --git a/src/invidious/database/videos.cr b/src/invidious/database/videos.cr
index 695f5b3..4baf1c4 100644
--- a/src/invidious/database/videos.cr
+++ b/src/invidious/database/videos.cr
@@ -11,6 +11,8 @@ module Invidious::Database::Videos
     SQL
 
     PG_DB.exec(request, video.id, video.info.to_json, video.updated)
+    REDIS_DB.set(video.id, video.info.to_json, ex: 3600)
+    REDIS_DB.set(video.id + ":time", video.updated, ex: 3600)
   end
 
   def delete(id)
@@ -20,6 +22,8 @@ module Invidious::Database::Videos
     SQL
 
     PG_DB.exec(request, id)
+    REDIS_DB.del(id)
+    REDIS_DB.del(id + ":time")
   end
 
   def delete_expired
@@ -39,6 +43,8 @@ module Invidious::Database::Videos
     SQL
 
     PG_DB.exec(request, video.id, video.info.to_json, video.updated)
+    REDIS_DB.set(video.id, video.info.to_json, ex: 3600)
+    REDIS_DB.set(video.id + ":time", video.updated, ex: 3600)
   end
 
   def select(id : String) : Video?
@@ -47,6 +53,14 @@ module Invidious::Database::Videos
       WHERE id = $1
     SQL
 
-    return PG_DB.query_one?(request, id, as: Video)
+    if ((info = REDIS_DB.get(id)) && (time = REDIS_DB.get(id + ":time")))
+      return Video.new({
+        id:      id,
+        info:    JSON.parse(info).as_h,
+        updated: Time.parse(time, "%Y-%m-%d %H:%M:%S %z", Time::Location::UTC),
+      })
+    else
+      return nil
+    end
   end
 end
diff --git a/src/invidious/videos.cr b/src/invidious/videos.cr
index 0446922..2869b42 100644
--- a/src/invidious/videos.cr
+++ b/src/invidious/videos.cr
@@ -305,7 +305,7 @@ def get_video(id, refresh = true, region = nil, force_refresh = false)
        video.schema_version != Video::SCHEMA_VERSION # cache control
       begin
         video = fetch_video(id, region)
-        Invidious::Database::Videos.update(video)
+        Invidious::Database::Videos.insert(video)
       rescue ex
         Invidious::Database::Videos.delete(id)
         raise ex
-- 
2.52.0

